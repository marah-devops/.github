name: Required - PR title follows KAN ticket pattern

on:
  workflow_call:
    inputs:
      ticket-prefix:
        description: 'Ticket prefix pattern (e.g., KAN, JIRA, TICKET, AU)'
        required: false
        type: string
        default: 'KAN'
  pull_request:
    branches:
      - main
      - master
      - dev
      - develop
    types: [opened, edited, reopened, synchronize, ready_for_review]

jobs:
  validate-title:
    name: Validate PR title prefix
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Check PR title starts with ticket number
        shell: bash
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          TICKET_PREFIX: ${{ inputs.ticket-prefix || 'KAN' }}
        run: |
          echo "PR title: '$PR_TITLE'"
          echo "Expected format: '${TICKET_PREFIX}-<number>: <description>' (supports multiple tickets and various separators)"

          # Define the pattern for a single ticket: PREFIX-NUMBER (no leading zeros, no zero)
          ticket_pattern="${TICKET_PREFIX}-[1-9][0-9]*"

          # Pattern for multiple tickets with various separators: space, comma, slash, or combinations
          # Also supports brackets/parentheses around tickets
          # Valid: AU-1: , AU-1 AU-2: , AU-1,AU-2: , AU-3 / AU-4: , (AU-5) , [AU-6]
          if [[ "$PR_TITLE" =~ ^(\(|\[)?${TICKET_PREFIX}-[1-9][0-9]*(\)|\])?(([[:space:]]*[,/][[:space:]]*|\[)?${TICKET_PREFIX}-[1-9][0-9]*(\])?)*([[:space:]]*:?[[:space:]]*-?[[:space:]]+) ]]; then
            echo "✅ PR title is valid."
          else
            echo "::error title=Invalid PR title::Title must start with '${TICKET_PREFIX}-' followed by a non-zero number (no leading zeros)."
            echo ""
            echo "Examples of VALID titles:"
            echo "  ✅ '${TICKET_PREFIX}-1: Fix login'"
            echo "  ✅ '${TICKET_PREFIX}-1 ${TICKET_PREFIX}-2: Implement feature'"
            echo "  ✅ '${TICKET_PREFIX}-1,${TICKET_PREFIX}-2: Cleanup'"
            echo "  ✅ '${TICKET_PREFIX}-3 / ${TICKET_PREFIX}-4: Refactor'"
            echo "  ✅ '(${TICKET_PREFIX}-5) Improve tests'"
            echo "  ✅ '[${TICKET_PREFIX}-6] Add documentation'"
            echo ""
            echo "Examples of INVALID titles:"
            echo "  ❌ '${TICKET_PREFIX,,}-1' (lowercase prefix)"
            echo "  ❌ '${TICKET_PREFIX}-0' (zero ticket number)"
            echo "  ❌ '${TICKET_PREFIX}-00' (zero with leading zero)"
            echo "  ❌ '${TICKET_PREFIX}-01' (leading zero)"
            echo "  ❌ '${TICKET_PREFIX}-8Update' (no separator after number)"
            exit 1
          fi
